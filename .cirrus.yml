env:
  GITHUB_TOKEN: ENCRYPTED[1c2ef2877c7f171e40a831f61367e810b57010d6b2eded04f68177e3ec096c3c85619be02f3f0c081fd1eb9b64dd15bb]

macos_universal_task:
  macos_instance:
    image: big-sur-xcode
  env:
    RUST_HOME: $HOME/macos
    CARGO_HOME: $RUST_HOME/cargo
    RUSTUP_HOME: $RUST_HOME/rustup
    PATH: $CARGO_HOME/bin:$PATH
  rust_cache:
    folder: $RUST_HOME
    reupload_on_changes: true
    fingerprint_script:
      - echo $CIRRUS_OS
      - date +%Y
    populate_script: >
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs |
      sh -s -- -y --verbose --no-modify-path --target aarch64-apple-darwin
  update_script: rustup --verbose update
  target_cache:
    folder: target
    reupload_on_changes: true
    fingerprint_script:
      - echo $CIRRUS_OS
      - rustc --version
  build_script:
    - cargo build --verbose --release --target aarch64-apple-darwin
    - mv target/aarch64-apple-darwin/release/yj yj.macos.aarch64
    - cargo build --verbose --release --target x86_64-apple-darwin
    - mv target/x86_64-apple-darwin/release/yj yj.macos.x86_64
    - lipo -create -output yj.macos.universal yj.macos.aarch64 yj.macos.x86_64
    - file yj.macos.universal
  binary_artifacts:
    path: yj.macos.*
  release_script: ./upload-binary.sh yj.macos.*
  before_cache_script: rm -f target/.rustc_info.json

linux_x68_64_task:
  container:
    image: rust:latest
  registry_cache:
    folder: $CARGO_HOME/registry
    reupload_on_changes: true
    fingerprint_script: date +%Y
  target_cache:
    folder: target
    reupload_on_changes: true
    fingerprint_script:
      - echo $CIRRUS_OS
      - rustc --version
  setup_script:
    - echo NOPE apt-get update
    - echo NOPE apt-get --yes install musl-tools
    - rustup target add x86_64-unknown-linux-musl
  build_script:
    - cargo build --verbose --release --target x86_64-unknown-linux-musl
    - mv target/x86_64-unknown-linux-musl/release/yj yj.$CIRRUS_OS.x86_64
    - file yj.$CIRRUS_OS.x86_64
    - ldd yj.$CIRRUS_OS.x86_64
  binary_artifacts:
    path: yj.$CIRRUS_OS.*
  release_script: ./upload-binary.sh yj.$CIRRUS_OS.*
  before_cache_script: rm -f target/.rustc_info.json

freebsd_x86_task:
  freebsd_instance:
    image_family: freebsd-12-2
  env:
    RUST_HOME: $HOME/freebsd
    CARGO_HOME: $RUST_HOME/cargo
    RUSTUP_HOME: $RUST_HOME/rustup
    PATH: $CARGO_HOME/bin:$PATH
  rust_cache:
    folder: $RUST_HOME
    reupload_on_changes: true
    fingerprint_script:
      - echo $CIRRUS_OS
      - date +%Y
    populate_script: >
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs |
      sh -s -- -y --verbose --no-modify-path
  update_script: rustup --verbose update
  target_cache:
    folder: target
    reupload_on_changes: true
    fingerprint_script:
      - echo $CIRRUS_OS
      - rustc --version
  build_script:
    - cargo build --verbose --release
    - mv target/release/yj yj.$CIRRUS_OS.x86_64
    - file yj.$CIRRUS_OS.x86_64
  binary_artifacts:
    path: yj.$CIRRUS_OS.*
  release_script: ./upload-binary.sh yj.$CIRRUS_OS.*
  before_cache_script: rm -f target/.rustc_info.json
